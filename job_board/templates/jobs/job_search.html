{% extends "base.html" %}
{% block title %}Find Jobs{% endblock %}

{% block content %}
<div class="search-header">
  <h1>Find Your Next Job</h1>
  <p class="text-muted">Search through {{ total_count }} active job posting{{ total_count|pluralize }}</p>
</div>

<!-- Search Form -->
<div class="card search-card">
  <form method="get" action="{% url 'jobs:search' %}" class="search-form">
    <div class="search-row">
      <div class="search-field search-field-main">
        {{ form.q.label_tag }}
        {{ form.q }}
        {% if form.q.errors %}
          <ul class="errorlist">{% for error in form.q.errors %}<li>{{ error }}</li>{% endfor %}</ul>
        {% endif %}
      </div>
      
      <div class="search-field">
        {{ form.location.label_tag }}
        {{ form.location }}
        {% if form.location.errors %}
          <ul class="errorlist">{% for error in form.location.errors %}<li>{{ error }}</li>{% endfor %}</ul>
        {% endif %}
      </div>
      
      <div class="search-field">
        <button type="submit" name="search" value="1" class="btn search-btn">Search Jobs</button>
      </div>
    </div>
    
    <!-- Advanced Filters -->
    <details class="filters-section">
      <summary class="filters-toggle">Advanced Filters</summary>
      <div class="filters-grid">
        <div class="field">
          {{ form.work_type.label_tag }}
          {{ form.work_type }}
          {% if form.work_type.errors %}<ul class="errorlist">{% for error in form.work_type.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
        </div>

        <div class="field">
          {{ form.salary_min.label_tag }}
          {{ form.salary_min }}
          {% if form.salary_min.errors %}<ul class="errorlist">{% for error in form.salary_min.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
        </div>

        <div class="field">
          {{ form.salary_max.label_tag }}
          {{ form.salary_max }}
          {% if form.salary_max.errors %}<ul class="errorlist">{% for error in form.salary_max.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
        </div>

        <div class="field">
          {{ form.visa_sponsorship.label_tag }}
          {{ form.visa_sponsorship }}
          {% if form.visa_sponsorship.errors %}
            <ul class="errorlist">
              {% for error in form.visa_sponsorship.errors %}<li>{{ error }}</li>{% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          {{ form.skills.label_tag }}
          {{ form.skills }}
          {% if form.skills.errors %}<ul class="errorlist">{% for error in form.skills.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
        </div>
        {# Hidden location fields (kept for GET) #}
        {{ form.lat }}
        {{ form.lng }}
        <span style="display:none;">{{ form.radius }}</span>

        <div class="distance-row">
          <label class="inline-control">
            {{ form.sort_by_distance }}
            <span>Sort by distance</span>
          </label>

          <label class="distance-label" for="radiusRange">Radius (miles):</label>
          <input id="radiusRange" type="range" min="1" max="200" step="1"
                value="{{ form.data.radius|default:form.fields.radius.initial|default:'25' }}">
          <strong class="radius-value"><span id="radiusVal">
            {{ form.data.radius|default:form.fields.radius.initial|default:'25' }}
          </span> mi</strong>

          <label class="inline-control">
            {{ form.filter_by_radius }}
            <span>Only show jobs within this radius</span>
          </label>
        </div>
      </div>
    </details>

    {% if has_filters %}
      <div class="active-filters">
        <a href="{% url 'jobs:search' %}" class="clear-filters">Clear all filters</a>
      </div>
    {% endif %}
  </form>
</div>

{% if jobs %}
  <!-- Pagination (top) -->
  <div class="pagination">
    {% if jobs.has_previous %}
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&amp;{% endif %}{% if request.GET.location %}location={{ request.GET.location }}&amp;{% endif %}{% if request.GET.work_type %}work_type={{ request.GET.work_type }}&amp;{% endif %}{% if request.GET.salary_min %}salary_min={{ request.GET.salary_min }}&amp;{% endif %}{% if request.GET.salary_max %}salary_max={{ request.GET.salary_max }}&amp;{% endif %}{% if request.GET.visa_sponsorship %}visa_sponsorship={{ request.GET.visa_sponsorship }}&amp;{% endif %}{% if request.GET.skills %}skills={{ request.GET.skills|urlencode }}&amp;{% endif %}page={{ jobs.previous_page_number }}" class="btn">Previous</a>
    {% else %}
      <span class="btn disabled">Previous</span>
    {% endif %}
    
    <span class="page-info">Page {{ jobs.number }} of {{ jobs.paginator.num_pages }}</span>
    
    {% if jobs.has_next %}
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&amp;{% endif %}{% if request.GET.location %}location={{ request.GET.location }}&amp;{% endif %}{% if request.GET.work_type %}work_type={{ request.GET.work_type }}&amp;{% endif %}{% if request.GET.salary_min %}salary_min={{ request.GET.salary_min }}&amp;{% endif %}{% if request.GET.salary_max %}salary_max={{ request.GET.salary_max }}&amp;{% endif %}{% if request.GET.visa_sponsorship %}visa_sponsorship={{ request.GET.visa_sponsorship }}&amp;{% endif %}{% if request.GET.skills %}skills={{ request.GET.skills|urlencode }}&amp;{% endif %}page={{ jobs.next_page_number }}" class="btn">Next</a>
    {% else %}
      <span class="btn disabled">Next</span>
    {% endif %}
  </div>

  <div class="results-meta">
    <p>{{ jobs.paginator.count }} job{{ jobs.paginator.count|pluralize }} found</p>
  </div>
  
  <div class="job-list">
    {% for job in jobs %}
      <div class="job-card">
        <div class="job-header">
          <h3><a href="{% url 'jobs:detail' job.pk %}">{{ job.title }}</a></h3>
          <div class="job-meta">
            <span class="company">{{ job.company }}</span>
            {% if job.location %}
              <span class="location">{{ job.location }}</span>
            {% endif %}
            <span class="work-type work-type-{{ job.work_type|lower }}">{{ job.get_work_type_display }}</span>
          </div>
        </div>
        
        <div class="job-details">
          <p class="job-description">{{ job.description|truncatechars:240 }}</p>
          <div class="job-info">
            {% if job.salary_min or job.salary_max %}
              <span class="salary">
                {% if job.salary_min and job.salary_max %}
                  {{ job.salary_currency }} {{ job.salary_min|floatformat:0 }} - {{ job.salary_max|floatformat:0 }}
                {% elif job.salary_min %}
                  From {{ job.salary_currency }} {{ job.salary_min|floatformat:0 }}
                {% else %}
                  Up to {{ job.salary_currency }} {{ job.salary_max|floatformat:0 }}
                {% endif %}
              </span>
            {% endif %}
            {% if job.visa_sponsorship %}
              <span class="visa">Visa Sponsorship</span>
            {% endif %}
          </div>
        </div>
        
        <div class="job-actions">
          <a class="btn btn-outline" href="{% url 'jobs:detail' job.pk %}">View Details</a>
        </div>
        {% if job.id in applied_job_ids %}<span class="applied-badge">Already Applied</span>{% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Map -->
  <div id="jobs-map" class="map card" style="height: 320px; margin-top: 24px;"></div>
  {% if jobs_for_map %}{{ jobs_for_map|json_script:"jobs-for-map-data" }}{% endif %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  document.addEventListener("DOMContentLoaded", function(){
    var container = document.getElementById("jobs-map");
    if (!container) return;

    var data = [];
    var el = document.getElementById("jobs-for-map-data");
    if (el) { try { data = JSON.parse(el.textContent); } catch(e) { console.warn("Bad jobs_for_map JSON", e); } }

    if (!data || !data.length) {
      container.innerHTML = '<div style="padding:12px;color:#6b7280;">No map locations available for these results.</div>';
      return;
    }

    var map = L.map("jobs-map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    var bounds = [];
    data.forEach(function(j){
      if (j.latitude == null || j.longitude == null) return;
      var m = L.marker([j.latitude, j.longitude]).addTo(map);
      var html = '<div style="min-width:180px;">'
               + '<div style="font-weight:600;margin-bottom:4px;">' + (j.title||"") + '</div>'
               + '<div style="color:#6b7280;margin-bottom:4px;">' + (j.company||"") + '</div>'
               + (j.location ? '<div style="color:#6b7280;">' + j.location + '</div>' : '')
               + '<div style="margin-top:8px;"><a href="' + j.url + '">View Job</a></div>'
               + '</div>';
      m.bindPopup(html);
      bounds.push([j.latitude, j.longitude]);
    });
    if (bounds.length) map.fitBounds(bounds, { padding: [24, 24] });
    const q = new URLSearchParams(window.location.search);
    const lat = parseFloat(q.get("lat"));
    const lng = parseFloat(q.get("lng"));
    const radius = parseFloat(q.get("radius") || "0");
    if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius) && radius > 0) {
      const m = L.marker([lat, lng]).addTo(map).bindPopup("Your location");
      const circle = L.circle([lat, lng], { radius: radius * 1609.34 }); 
      circle.addTo(map);
      bounds.push([lat, lng]);
      if (bounds.length) map.fitBounds(bounds, { padding: [24, 24] });
    }
  });
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const slider        = document.getElementById('radiusRange');
    const radiusHidden  = document.getElementById('id_radius');
    const radiusLabel   = document.getElementById('radiusVal');
    const latInput      = document.getElementById('id_lat');
    const lngInput      = document.getElementById('id_lng');
    const sortCb        = document.getElementById('id_sort_by_distance');
    const filterCb      = document.getElementById('id_filter_by_radius');

    const syncRadius = () => {
      if (slider && radiusHidden) {
        radiusHidden.value = slider.value;
        if (radiusLabel) radiusLabel.textContent = slider.value;
      }
    };
    syncRadius();
    if (slider) {
      slider.addEventListener('input', syncRadius);
    }

    const tryGeolocate = () => {
      if (!latInput || !lngInput) return;
      if (latInput.value && lngInput.value) return;
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => {
          latInput.value = pos.coords.latitude.toFixed(6);
          lngInput.value = pos.coords.longitude.toFixed(6);
        },
        () => { /* ignore errorsâ€”user may block location */ },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    };
    tryGeolocate();
  });
  </script>



  <!-- Pagination (bottom) -->
  <div class="pagination">
    {% if jobs.has_previous %}
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&amp;{% endif %}{% if request.GET.location %}location={{ request.GET.location }}&amp;{% endif %}{% if request.GET.work_type %}work_type={{ request.GET.work_type }}&amp;{% endif %}{% if request.GET.salary_min %}salary_min={{ request.GET.salary_min }}&amp;{% endif %}{% if request.GET.salary_max %}salary_max={{ request.GET.salary_max }}&amp;{% endif %}{% if request.GET.visa_sponsorship %}visa_sponsorship={{ request.GET.visa_sponsorship }}&amp;{% endif %}{% if request.GET.skills %}skills={{ request.GET.skills|urlencode }}&amp;{% endif %}page={{ jobs.previous_page_number }}" class="btn">Previous</a>
    {% else %}
      <span class="btn disabled">Previous</span>
    {% endif %}
    
    <span class="page-info">Page {{ jobs.number }} of {{ jobs.paginator.num_pages }}</span>
    
    {% if jobs.has_next %}
      <a href="?{% if request.GET.q %}q={{ request.GET.q }}&amp;{% endif %}{% if request.GET.location %}location={{ request.GET.location }}&amp;{% endif %}{% if request.GET.work_type %}work_type={{ request.GET.work_type }}&amp;{% endif %}{% if request.GET.salary_min %}salary_min={{ request.GET.salary_min }}&amp;{% endif %}{% if request.GET.salary_max %}salary_max={{ request.GET.salary_max }}&amp;{% endif %}{% if request.GET.visa_sponsorship %}visa_sponsorship={{ request.GET.visa_sponsorship }}&amp;{% endif %}{% if request.GET.skills %}skills={{ request.GET.skills|urlencode }}&amp;{% endif %}page={{ jobs.next_page_number }}" class="btn">Next</a>
    {% else %}
      <span class="btn disabled">Next</span>
    {% endif %}
  </div>
{% else %}
  <div class="no-results">
    <div class="no-results-content">
      <h3>No jobs found</h3>
      <p>Try broadening your search or clearing filters.</p>
    </div>
  </div>
{% endif %}

<style>
.search-header { margin-bottom: 24px; }
.search-header h1 { margin-bottom: 8px; }
.text-muted { color: #6b7280; }

.search-card { margin-bottom: 24px; }
.search-row { display: grid; grid-template-columns: 2fr 1fr auto; gap: 16px; margin-bottom: 16px; align-items: center; }
.search-field-main { grid-column: 1; }
.search-btn { white-space: nowrap; align-self: center; }

.filters-section { margin-top: 16px; border-top: 1px solid #e5e7eb; padding-top: 16px; }
.filters-toggle { cursor: pointer; font-weight: 600; color: #000; }
.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

.job-list { display: grid; grid-template-columns: 1fr; gap: 16px; }
.job-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; position: relative; }
.job-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.job-header h3 { margin: 0; }
.job-meta { color: #6b7280; display: flex; align-items: center; gap: 12px; }
.location { color: #6b7280; }
.work-type { background: #eef2ff; color: #1e3a8a; padding: 4px 12px; border-radius: 9999px; font-weight: 600; font-size: 0.85rem; }

.job-details { margin-top: 8px; }
.job-description { color: #374151; margin-bottom: 8px; }
.job-info { display: flex; align-items: center; gap: 12px; color: #374151; }
.salary { font-weight: 600; }
.visa { background: #ecfdf5; color: #065f46; padding: 4px 8px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; }

.job-actions { margin-top: 12px; display: flex; gap: 8px; }

.inline-control { display:flex; align-items:center; gap:.5rem; }
input[type="checkbox"] { transform: scale(1.2); accent-color:#2563eb; }

.pagination { display: flex; align-items: center; justify-content: space-between; margin: 16px 0; }

/* Button palette for this page (match global palette) */
.btn {
  background: #2563eb;               /* blue, not black */
  color: #fff;
  padding: 8px 12px;
  border-radius: 8px;
  text-decoration: none;
  border: 1px solid #2563eb;         /* ensure outline matches on hover borders */
}
.btn:hover { opacity: 0.9; }

.btn-outline {
  background: transparent;
  color: #2563eb;                    /* blue text */
  border: 1px solid #2563eb;         /* blue border */
}

.btn.disabled { opacity: 0.5; pointer-events: none; }


.page-info { padding: 8px 12px; color: #6b7280; }

.no-results { display: flex; justify-content: center; padding: 48px 0; }
.no-results-content { text-align: center; }
.no-results h3 { color: #374151; margin-bottom: 8px; }

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  align-items: start; /* added */
}

@media (max-width: 768px) {
  .search-row { grid-template-columns: 1fr; }
  .filters-grid { grid-template-columns: 1fr; }
  .job-meta { flex-direction: column; align-items: flex-start; gap: 8px; }
  .job-info { flex-direction: column; align-items: flex-start; gap: 8px; }
}
.applied-badge { position: absolute; right: 12px; bottom: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; padding: 4px 8px; font-weight: 600; font-size: 0.8rem; color: #374151; }
</style>
{% endblock %}
