{% extends "base.html" %}
{% block title %}{{ job.title }} at {{ job.company }}{% endblock %}

{% block content %}
<div class="job-detail-container">
  {% if user.is_authenticated and user.account_type == 'RECRUITER' %}
    <div style="margin: 0 0 16px 0;">
      <a href="{% url 'jobs:my_jobs' %}" class="btn btn-outline">‚Üê Back to My Jobs</a>
    </div>
  {% endif %}
  <!-- Job Header -->
  <div class="job-header-card card">
    <div class="job-header-content">
      <div class="job-title-section">
        <h1>{{ job.title }}</h1>
        <div class="job-company">
          <h2>{{ job.company }}</h2>
          {% if job.location %}
            <span class="job-location">{{ job.location }}</span>
          {% endif %}
        </div>
      </div>

      <div class="job-actions">
        {% if user_applied and user_application %}
          <!-- Replace Apply button with text -->
          <div class="applied-badge">Already Applied</div>
          <div style="margin-top:8px;">
            <a href="{% url 'jobs:application_detail' user_application.pk %}" class="btn btn-outline" style="font-size:0.9rem;">View Application</a>
          </div>
        {% elif can_apply %}
          <button type="button" id="quick-apply-btn" class="btn btn-primary">Apply</button>
        {% elif not user.is_authenticated %}
          <a href="{% url 'login' %}" class="btn btn-primary">Login to Apply</a>
        {% elif user == job.posted_by %}
          <div class="owner-actions">
            <a href="{% url 'jobs:edit' job.pk %}" class="btn btn-outline">Edit Job</a>
            <a href="{% url 'jobs:applications' job.pk %}" class="btn btn-outline">View Applications</a>
          </div>
        {% endif %}
        
        {% if user.is_authenticated and user != job.posted_by %}
          <div style="margin-top: 12px;">
            <a href="{% url 'jobs:report_job' job.pk %}" class="btn btn-text" style="color: #6b7280; font-size: 0.9rem;">
              üö© Report Job
            </a>
          </div>
        {% endif %}
      </div>
    </div>

    {% if user.is_staff and job_reports %}
    <!-- Admin: Show Reports -->
    <div class="admin-alerts" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0;">
      <h4 style="color: #92400e; margin: 0 0 12px 0; font-size: 1rem;">‚ö†Ô∏è This job has been reported ({{ job_reports.count }} report{{ job_reports.count|pluralize }})</h4>
      {% for report in job_reports|slice:":3" %}
        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
          <strong>{{ report.get_reason_display }}</strong> - Reported by {{ report.reported_by.username }}
          <small style="color: #6b7280; display: block;">{{ report.created_at|date:"M d, Y H:i" }}</small>
          {% if report.description %}
            <p style="margin: 8px 0 0 0; color: #374151;">{{ report.description|truncatechars:100 }}</p>
          {% endif %}
        </div>
      {% endfor %}
      <a href="{% url 'admin:jobs_jobreport_changelist' %}?job__id__exact={{ job.pk }}" style="color: #92400e; font-weight: 600;">
        View all reports in admin ‚Üí
      </a>
    </div>
    {% endif %}

    <div class="job-meta-bar">
      <div class="job-meta-item">
        <span class="meta-label">Work Type:</span>
        <span class="work-type work-type-{{ job.work_type|lower }}">{{ job.get_work_type_display }}</span>
      </div>
      {% if job.salary_min or job.salary_max %}
      <div class="job-meta-item">
        <span class="meta-label">Salary:</span>
        <span class="salary">{{ job.salary_range_display }}</span>
      </div>
      {% endif %}
      {% if job.visa_sponsorship %}
      <div class="job-meta-item">
        <span class="meta-label">Visa:</span>
        <span class="visa">Sponsorship Available</span>
      </div>
      {% endif %}
      <div class="job-meta-item">
        <span class="meta-label">Posted:</span>
        <span class="posted">{{ job.created_at|date:"M d, Y" }}</span>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="job-content-grid">
    <!-- Left column -->
    <div class="job-main">
      <div class="card section">
        <h3>About the Role</h3>
        <div class="prose">
          {{ job.description|linebreaks }}
        </div>
      </div>

      {% if job.requirements %}
      <div class="card section">
        <h3>Requirements</h3>
        <div class="prose">
          {{ job.requirements|linebreaks }}
        </div>
      </div>
      {% endif %}

      {% if job.benefits %}
      <div class="card section">
        <h3>Benefits</h3>
        <div class="prose">
          {{ job.benefits|linebreaks }}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="job-sidebar">
      {% if job.required_skills.all %}
        <div class="skills-card card">
          <h4>Required Skills</h4>
          <div class="skills-list">
            {% for skill in job.required_skills.all %}
              <span class="skill-tag skill-required">{{ skill.name }}</span>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if job.nice_to_have_skills.all %}
        <div class="skills-card card">
          <h4>Nice to Have</h4>
          <div class="skills-list">
            {% for skill in job.nice_to_have_skills.all %}
              <span class="skill-tag">{{ skill.name }}</span>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Company + Location -->
      <div class="card">
        <h4>Company</h4>
        <div class="detail-row">
          <div class="detail-label">Name</div>
          <div class="detail-value">{{ job.company }}</div>
        </div>
        {% if job.location %}
        <div class="detail-row">
          <div class="detail-label">Location</div>
          <div class="detail-value">{{ job.location }}</div>
        </div>
        {% endif %}
        {% if job.expires_at %}
        <div class="detail-row">
          <div class="detail-label">Expires</div>
          <div class="detail-value">{{ job.expires_at|date:"M d, Y" }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if can_apply %}
  <!-- Application section at the bottom -->
  <div id="apply-section" class="card" style="display:none; margin-top: 24px;">
    <h3>Finish Application</h3>
    <p class="muted" style="margin-top:-4px;">Add a short note for the employer (optional)</p>

    <form id="quick-apply-ajax-form">
      {% csrf_token %}
      <div class="field">
        {{ quick_form.tailored_note.label_tag }}
        {{ quick_form.tailored_note }}
        <div class="field-help">{{ quick_form.tailored_note.help_text }}</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button type="submit" class="btn btn-primary">Submit Application</button>
        <button type="button" id="cancel-quick-apply" class="btn btn-outline">Cancel</button>
      </div>
    </form>
  </div>
  {% endif %}

  {# ---------------- Recruiter-only Applicant Map (bottom) ---------------- #}
  {% if user.is_authenticated and user == job.posted_by %}
    <div class="card section" id="applicant-map-section" style="margin-top:16px;">
      <h3>Applicant Locations</h3>
      <div id="applicant-map" style="height:420px; border-radius:8px; margin-top:8px;"></div>
      <p class="muted" style="font-size:0.9rem; margin-top:6px;">
        {% comment %} Always render; pins appear as applicants apply. {% endcomment %}
        Pins are based on applicants' profile locations.
      </p>
    </div>

    <!-- Leaflet CSS/JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
    (function(){
      try {
        var markers = JSON.parse('{{ applicant_markers_json|escapejs }}' || '[]');
        var mapEl   = document.getElementById('applicant-map');
        if (!mapEl) return;

        var map = L.map('applicant-map', { scrollWheelZoom: false });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var bounds = [];
        (markers || []).forEach(function(m){
          var mk = L.marker([m.lat, m.lng]).addTo(map);
          var html = '<div><strong>' + (m.label || 'Applicant') + '</strong>';
          if (m.location) html += '<br/>' + m.location;
          if (m.status)   html += '<br/><span style="opacity:0.8;">Status: ' + m.status.replace('_', ' ') + '</span>';
          if (m.profile_url) html += '<br/><a href="' + m.profile_url + '">View profile</a>';
          html += '</div>';
          mk.bindPopup(html);
          bounds.push([m.lat, m.lng]);
        });

        if (bounds.length === 1) {
          map.setView(bounds[0], 9);
        } else if (bounds.length > 1) {
          map.fitBounds(bounds, { padding: [30, 30] });
        } else {
          // No markers yet: show a world-ish view
          map.setView([20, 0], 2);
        }

        setTimeout(function(){ map.invalidateSize(); }, 250);
      } catch (e) {
        if (window.console && console.warn) console.warn('Applicant map failed:', e);
      }
    })();
    </script>
  {% endif %}
</div>

<style>
.job-detail-container { max-width:1100px; margin:0 auto; padding:16px; }
.job-header-card { margin-bottom:16px; }
.job-header-content { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
.job-title-section h1 { margin:0; }
.job-company h2 { margin:0; font-size:1.125rem; font-weight:600; }
.job-location { color:#6b7280; margin-left:0; display:block; }
.job-actions { min-width:260px; text-align:right; }
.applied-badge { display:inline-block; background:#dcfce7; color:#166534; border:1px solid #22c55e; border-radius:999px; padding:6px 12px; font-weight:600; margin-bottom:6px; }
.job-meta-bar { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:8px; margin-top:12px; color:#374151; }
.job-meta-item { display:flex; align-items:center; gap:8px; }
.meta-label { font-weight:600; color:#111827; }
.section h3 { margin:0 0 8px; }
.skills-card .skills-list { display:flex; flex-wrap:wrap; gap:8px; }
.skill-tag { display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; background:#f9fafb; border-radius:999px; font-size:0.85rem; }
.skill-required { background:#eef2ff; border-color:#c7d2fe; }
.job-content-grid { display:grid; grid-template-columns:1fr 320px; gap:16px; }
.card.section { margin-bottom:16px; }

/* Company/Location summary alignment */
.detail-row { display:grid; grid-template-columns:100px 1fr; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb; }
.detail-label { color:#6b7280; text-align:left; }
.detail-value { text-align:left; }

@media (max-width: 900px) {
  .job-content-grid { grid-template-columns:1fr; }
  .job-actions { text-align:left; min-width:auto; }
  .detail-label, .detail-value { text-align:left; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quickApplyBtn = document.getElementById('quick-apply-btn');
  const applySection  = document.getElementById('apply-section');
  const cancelBtn     = document.getElementById('cancel-quick-apply');
  const ajaxForm      = document.getElementById('quick-apply-ajax-form');

  if (quickApplyBtn && applySection) {
    quickApplyBtn.addEventListener('click', function() {
      applySection.style.display = 'block';
      const ta = applySection.querySelector('textarea');
      if (ta && ta.focus) ta.focus({ preventScroll: true });
      applySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }

  if (cancelBtn && applySection) {
    cancelBtn.addEventListener('click', function() {
      applySection.style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  if (ajaxForm) {
    ajaxForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitBtn = ajaxForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = 'Applying...';

      try {
        const formData = new FormData(ajaxForm);
        const resp = await fetch('{% url "jobs:quick_apply" job.pk %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });

        // Read as text first (works even if server sets an unexpected content-type)
        const raw = await resp.text();
        let data = null;
        try { data = JSON.parse(raw); } catch (_) { /* not JSON; that's fine */ }

        // Treat any 2xx response as success, even if JSON parsing fails
        if (resp.status >= 200 && resp.status < 300 && (!data || data.success !== false)) {
            if (data && data.redirect_url) {
              window.location.assign(data.redirect_url);
            } else {
              window.location.reload();
            }
            return; // stop processing
        }

        // Otherwise, surface the best available error message
        const msg = (data && (data.error || data.message)) || 'Unable to submit application.';
        throw new Error(msg);

      } catch (err) {
        alert(err.message || 'An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }
});
</script>
{% endblock %}
