{% extends "base.html" %}
{% block title %}Application: {{ application.job.title }}{% endblock %}
{% block content %}
<div class="application-detail-container" style="max-width: 800px; margin: 0 auto;">

  <!-- Job Details Summary (first) -->
  <div class="card">
    <h2 style="margin: 0 0 20px;">Job Summary</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
      <div>
        <strong style="color: #374151;">Company:</strong><br>
        <span style="color: #6b7280;">{{ application.job.company }}</span>
      </div>
      <div>
        <strong style="color: #374151;">Location:</strong><br>
        <span style="color: #6b7280;">{{ application.job.location|default:"—" }}</span>
      </div>
      <div>
        <strong style="color: #374151;">Work Type:</strong><br>
        <span style="color: #6b7280;">{{ application.job.get_work_type_display|default:"—" }}</span>
      </div>
      <div>
        <strong style="color: #374151;">Salary:</strong><br>
        <span style="color: #6b7280;">
          {% if application.job.salary_min or application.job.salary_max %}
            {% if application.job.salary_min %}${{ application.job.salary_min }}{% endif %}
            {% if application.job.salary_min and application.job.salary_max %}–{% endif %}
            {% if application.job.salary_max %}${{ application.job.salary_max }}{% endif %}
          {% else %}—{% endif %}
        </span>
      </div>
      <div>
        <strong style="color: #374151;">Job Status:</strong><br>
        <span class="status-badge" style="
          {% if application.job.status == application.job.Status.ACTIVE %}
            background:#dcfce7;color:#166534;border:1px solid #bbf7d0;
          {% else %}
            background:#fee2e2;color:#991b1b;border:1px solid #fecaca;
          {% endif %}
        ">
          {{ application.job.get_status_display }}
        </span>
      </div>
      <div>
        <strong style="color:#374151;">Application Status:</strong><br>
        <span class="status-badge" style="
          {% if application.status == 'APPLIED' %}
            background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe;
          {% elif application.status == 'REVIEWING' %}
            background:#fef3c7;color:#92400e;border:1px solid #fde68a;
          {% elif application.status == 'INTERVIEW' %}
            background:#e0e7ff;color:#3730a3;border:1px solid #c7d2fe;
          {% elif application.status == 'OFFER' %}
            background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;
          {% elif application.status == 'ACCEPTED' %}
            background:#dcfce7;color:#166534;border:1px solid #bbf7d0;
          {% elif application.status == 'REJECTED' %}
            background:#fee2e2;color:#991b1b;border:1px solid #fecaca;
          {% endif %}
        ">
          {{ application.get_status_display }}
        </span>
        <p style="margin:6px 0 0;color:#6b7280;">{{ application.get_status_help_text }}</p>
      </div>
    </div>

    <!-- Description + skills inside the summary card -->
    {% if application.job.description %}
      <div style="margin-top:12px;">
        <h3 style="margin:0 0 6px;">Job Description</h3>
        <div style="line-height:1.6;">{{ application.job.description|linebreaks }}</div>
      </div>
    {% endif %}

    {% if application.job.required_skills.count %}
      <div style="margin-top:12px;">
        <strong>Required Skills:</strong>
        <span class="field-help">{{ application.job.required_skills.all|join:", " }}</span>
      </div>
    {% endif %}

    {% if application.job.nice_to_have_skills.count %}
      <div style="margin-top:6px;">
        <strong>Preferred Skills:</strong>
        <span class="field-help">{{ application.job.nice_to_have_skills.all|join:", " }}</span>
      </div>
    {% endif %}

    {% if request.user == application.job.posted_by %}
      <form method="post"
            action="{% url 'jobs:application_status_update' application.pk %}"
            class="application-status-form"
            style="display:flex; gap:10px; align-items:center; justify-content:center; width:100%; margin-top:16px;">
        {% csrf_token %}
        {{ form.status }}
        <button class="btn" type="submit">Update Status</button>
      </form>
    {% endif %}

  </div>

  <!-- Applicant Profile (second) -->
  <div style="margin-top: 16px;">
    {% if profile %}
      {% include "profiles/_profile_public_block.html" with profile=profile experiences_qs=experiences_qs educations_qs=educations_qs links_qs=links_qs %}
    {% endif %}
  </div>

  <!-- Applicant Note (third) -->
  {% if application.cover_letter %}
    <div class="card" style="margin-top: 16px;">
      <strong>Applicant Note</strong>
      <div style="margin-top:8px; font-size:0.95rem; line-height:1.6;">
        {{ application.cover_letter|linebreaks }}
      </div>
    </div>
  {% endif %}

  <!-- Change History (fourth) -->
  {% if history %}
    <div class="card" style="margin-top: 16px;">
      <strong>Status History</strong>
      <ul class="list" style="margin-top:8px;">
        {% for h in history %}
          <li>
            <strong>{{ h.get_new_status_display }}</strong>
            <span class="muted"> — {{ h.changed_at|date:"M j, Y, g:i A" }}</span>
            {% if h.notes %}<div class="muted">{{ h.notes }}</div>{% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if request.user == application.applicant and application.status == 'OFFER' %}
    <form method="post" action="{% url 'jobs:application_accept' application.pk %}" style="margin-top:12px;">
      {% csrf_token %}
      <button class="btn" type="submit">Accept Offer</button>
    </form>
  {% endif %}
</div>

<style>
/* Keep consistent with existing style system */
.status-badge { 
  display: inline-block; 
  padding: 4px 10px; 
  border-radius: 999px; 
  font-weight: 600; 
  font-size: 0.85rem; 
}

/* Scoped tweaks for the status form only */
.application-status-form select[name="status"] {
  width: auto;          /* don't stretch */
  min-width: 180px;     /* readable but not huge */
  max-width: 260px;     /* cap width */
  flex: 0 0 auto;       /* prevent flex-grow */
}

.application-status-form {
  justify-content: center; /* center dropdown + button */
}

.application-status-form .btn {
  min-width: 150px;     /* ensure text stays on one line */
  white-space: nowrap;  /* never wrap inside button */
}

/* Mobile: allow wrapping if space is tight, button full width */
@media (max-width: 480px) {
  .application-status-form { flex-wrap: wrap; }
  .application-status-form .btn { width: 100%; }
}
</style>
{% endblock %}
