{% extends "base.html" %}
{% block title %}Edit Profile{% endblock %}
{% block content %}
  <div class="card">
    <h1>Edit Profile</h1>

    <!-- Ensure POST goes to edit view; novalidate so browser checks donâ€™t block submit -->
    <form method="post" action="{% url 'profiles:edit_profile' %}" id="edit-form" novalidate>
      {% csrf_token %}
      <section style="margin-top:8px;">
        <h2>Basics</h2>
        <div class="form-grid">
          {{ pform.headline.label_tag }}{{ pform.headline }}
          {{ pform.location.label_tag }}{{ pform.location }}
        </div>
        <div style="margin-top:12px;">
          {{ pform.summary.label_tag }}{{ pform.summary }}
        </div>
        <div style="margin-top:12px;">
          {{ pform.skills_csv.label_tag }}{{ pform.skills_csv }}
          <div class="field-help">{{ pform.skills_csv.help_text }}</div>
        </div>
      </section>

      <!-- EXPERIENCE -->
      <section style="margin-top:6px;" id="exp-section">
        <h2>Experience</h2>

        {# Show any formset-level errors at top of the section #}
        {% if xformset.non_form_errors %}
          <ul class="errorlist" style="display:inline-block; margin:6px 0 0 0;">
            {% for err in xformset.non_form_errors %}<li>{{ err }}</li>{% endfor %}
          </ul>
        {% endif %}

        {{ xformset.management_form }}
        <div class="fs-rows" data-prefix="exp">
        {% for form in xformset %}
          {{ form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="{{ form.prefix }}">

            {# Move row-level errors to the very top of the card (above Title) #}
            {% if form.errors %}
            <ul class="errorlist" style="margin-top:6px;">
              {% for field, errs in form.errors.items %}
                {% for e in errs %}<li>{{ field|capfirst }}: {{ e }}</li>{% endfor %}
              {% endfor %}
            </ul>
            {% endif %}

            <div class="form-grid">
              <div class="field">{{ form.title.label_tag }}{{ form.title }}</div>
              <div class="field">{{ form.company.label_tag }}{{ form.company }}</div>
              <div class="field start-date-wrapper">{{ form.start_date.label_tag }}{{ form.start_date }}</div>
              <div class="field end-date-wrapper">{{ form.end_date.label_tag }}{{ form.end_date }}</div>
              <div class="field current-wrapper">
                <label for="{{ form.current.id_for_label }}">{{ form.current.label }}</label>
                {{ form.current }}
              </div>
            </div>

            <div style="margin-top:8px;">{{ form.description.label_tag }}{{ form.description }}</div>

            <span class="hidden-delete">{{ form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        {% endfor %}
        </div>
        <button type="button" class="btn add-row" data-section="exp">Add experience</button>

        <template id="exp-empty-form">
          {{ xformset.empty_form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="exp-__prefix__">
            <div class="form-grid">
              <div class="field">{{ xformset.empty_form.title.label_tag }}{{ xformset.empty_form.title }}</div>
              <div class="field">{{ xformset.empty_form.company.label_tag }}{{ xformset.empty_form.company }}</div>
              <div class="field start-date-wrapper">{{ xformset.empty_form.start_date.label_tag }}{{ xformset.empty_form.start_date }}</div>
              <div class="field end-date-wrapper">{{ xformset.empty_form.end_date.label_tag }}{{ xformset.empty_form.end_date }}</div>
              <div class="field current-wrapper">
                <label for="{{ xformset.empty_form.current.id_for_label }}">{{ xformset.empty_form.current.label }}</label>
                {{ xformset.empty_form.current }}
              </div>
            </div>
            <div style="margin-top:8px;">{{ xformset.empty_form.description.label_tag }}{{ xformset.empty_form.description }}</div>
            <span class="hidden-delete">{{ xformset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        </template>
      </section>

      <!-- EDUCATION -->
      <section style="margin-top:6px;" id="edu-section">
        <h2>Education</h2>

        {% if eformset.non_form_errors %}
          <ul class="errorlist" style="display:inline-block; margin:6px 0 0 0;">
            {% for err in eformset.non_form_errors %}<li>{{ err }}</li>{% endfor %}
          </ul>
        {% endif %}

        {{ eformset.management_form }}
        <div class="fs-rows" data-prefix="edu">
        {% for form in eformset %}
          {{ form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="{{ form.prefix }}">

            {% if form.errors %}
            <ul class="errorlist" style="margin-top:6px;">
              {% for field, errs in form.errors.items %}
                {% for e in errs %}<li>{{ field|capfirst }}: {{ e }}</li>{% endfor %}
              {% endfor %}
            </ul>
            {% endif %}

            <div class="form-grid">
              <div class="field">{{ form.school.label_tag }}{{ form.school }}</div>
              <div class="field">{{ form.degree.label_tag }}{{ form.degree }}</div>
              <div class="field">{{ form.field_of_study.label_tag }}{{ form.field_of_study }}</div>
              <div class="field start-date-wrapper">{{ form.start_date.label_tag }}{{ form.start_date }}</div>
              <div class="field end-date-wrapper">{{ form.end_date.label_tag }}{{ form.end_date }}</div>
              <div class="field current-wrapper">
                <label for="{{ form.current.id_for_label }}">{{ form.current.label }}</label>
                {{ form.current }}
              </div>
            </div>

            <div style="margin-top:8px;">{{ form.description.label_tag }}{{ form.description }}</div>
            <span class="hidden-delete">{{ form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        {% endfor %}
        </div>
        <button type="button" class="btn add-row" data-section="edu">Add education</button>

        <template id="edu-empty-form">
          {{ eformset.empty_form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="edu-__prefix__">
            <div class="form-grid">
              <div class="field">{{ eformset.empty_form.school.label_tag }}{{ eformset.empty_form.school }}</div>
              <div class="field">{{ eformset.empty_form.degree.label_tag }}{{ eformset.empty_form.degree }}</div>
              <div class="field">{{ eformset.empty_form.field_of_study.label_tag }}{{ eformset.empty_form.field_of_study }}</div>
              <div class="field start-date-wrapper">{{ eformset.empty_form.start_date.label_tag }}{{ eformset.empty_form.start_date }}</div>
              <div class="field end-date-wrapper">{{ eformset.empty_form.end_date.label_tag }}{{ eformset.empty_form.end_date }}</div>
              <div class="field current-wrapper">
                <label for="{{ eformset.empty_form.current.id_for_label }}">{{ eformset.empty_form.current.label }}</label>
                {{ eformset.empty_form.current }}
              </div>
            </div>
            <div style="margin-top:8px;">{{ eformset.empty_form.description.label_tag }}{{ eformset.empty_form.description }}</div>
            <span class="hidden-delete">{{ eformset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        </template>
      </section>

      <!-- LINKS -->
      <section style="margin-top:6px;" id="lnk-section">
        <h2>Links</h2>

        {% if lformset.non_form_errors %}
          <ul class="errorlist" style="display:inline-block; margin:6px 0 0 0;">
            {% for err in lformset.non_form_errors %}<li>{{ err }}</li>{% endfor %}
          </ul>
        {% endif %}

        {{ lformset.management_form }}
        <div class="fs-rows" data-prefix="lnk">
        {% for form in lformset %}
          {{ form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="{{ form.prefix }}">

            {% if form.errors %}
            <ul class="errorlist" style="margin-top:6px;">
              {% for field, errs in form.errors.items %}
                {% for e in errs %}<li>{{ field|capfirst }}: {{ e }}</li>{% endfor %}
              {% endfor %}
            </ul>
            {% endif %}

            <div class="form-grid">
              <label for="{{ form.kind.id_for_label }}">Type</label>{{ form.kind }}
              {{ form.label.label_tag }}{{ form.label }}
              {{ form.url.label_tag }}{{ form.url }}
            </div>

            <span class="hidden-delete">{{ form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        {% endfor %}
        </div>
        <button type="button" class="btn add-row" data-section="lnk">Add link</button>

        <template id="lnk-empty-form">
          {{ lformset.empty_form.id }}
          <div class="card fs-row" style="margin:10px 0;" data-prefix="lnk-__prefix__">
            <div class="form-grid">
              <label for="{{ lformset.empty_form.kind.id_for_label }}">Type</label>{{ lformset.empty_form.kind }}
              {{ lformset.empty_form.label.label_tag }}{{ lformset.empty_form.label }}
              {{ lformset.empty_form.url.label_tag }}{{ lformset.empty_form.url }}
            </div>
            <span class="hidden-delete">{{ lformset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-outline delete-row" onclick="__formsetDelete(this)">Delete</button>
          </div>
        </template>
      </section>

      <p style="margin-top:16px;">
        <input class="btn" type="submit" value="Save changes" id="save-btn">
        <a class="btn btn-outline" href="{% url 'profiles:my_profile' %}" style="margin-left:8px;">Cancel</a>
      </p>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
/* date picker: no left margin */
.js-date{ width:min(640px, 100%); margin-left:0; }

/* space between description and Delete button */
.fs-row .delete-row{ margin-top:8px; }

/* hide real DELETE fields cleanly */
.hidden-delete, .fs-row input[name$="-DELETE"] { display:none; }

/* single-line, left-aligned Current label + checkbox */
.field.current-wrapper{
  display:flex !important;
  flex-direction:row !important;
  align-items:center;
  justify-content:flex-start;
  gap:8px;
  margin-left:0 !important;
  text-align:left !important;
}
.field.current-wrapper > label{ margin:0; line-height:1.2; }
.field.current-wrapper input[type="checkbox"]{ margin:0; }

/* keep date wrappers stacked */
.start-date-wrapper, .end-date-wrapper { display:flex; flex-direction:column; }
</style>

<script>
(function(){
  var dateOpts = { dateFormat: 'Y-m-d', locale: 'en' };
  try { if (window.flatpickr) { flatpickr('.js-date', dateOpts); } } catch(e) {}

  function renumberForm(html, prefix, index) {
    var re = new RegExp(prefix + '-__prefix__', 'g');
    return html.replace(re, prefix + '-' + index);
  }

  function updateCurrentToggles(scope) {
    (scope || document).querySelectorAll('.fs-row .current-wrapper input[type="checkbox"]').forEach(function(cb){
      function sync(){
        var row = cb.closest('.fs-row');
        var endWrap = row && row.querySelector('.end-date-wrapper');
        if (!endWrap) return;
        endWrap.style.display = cb.checked ? 'none' : '';
        if (cb.checked) {
          var endInput = endWrap.querySelector('input, select, textarea');
          if (endInput) { endInput.value = ''; }
        }
      }
      cb.addEventListener('change', sync);
      sync();
    });
  }

  // Consider a formset row "empty" iff:
  // - no errors in the row, and
  // - all inputs/textareas are blank/unchecked, and
  // - for selects: the FIRST option is selected OR the selected option's value is empty.
  function rowIsEmpty(row){
    if (row.querySelector('.errorlist li')) return false;

    var fields = row.querySelectorAll('input, textarea, select');
    for (var i = 0; i < fields.length; i++){
      var el = fields[i];
      if (!el.name) continue;
      if (/-DELETE$/.test(el.name) || /-id$/.test(el.name)) continue;

      if (el.tagName === 'SELECT') {
        var selEmpty = (el.selectedIndex <= 0);
        if (!selEmpty && el.options && el.options[el.selectedIndex]) {
          var v = (el.options[el.selectedIndex].value || '').trim();
          selEmpty = (v === '');
        }
        if (!selEmpty) return false;
        continue;
      }

      if (el.type === 'checkbox' || el.type === 'radio') {
        if (el.checked) return false;
      } else {
        if (el.value && String(el.value).trim() !== '') return false;
      }
    }
    return true;
  }

  function setupSection(sectionId) {
    var section = document.getElementById(sectionId + '-section');
    if (!section) return;

    var rowsWrap     = section.querySelector('.fs-rows');
    var prefix       = rowsWrap.getAttribute('data-prefix');
    var totalInput   = section.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');
    var initialInput = section.querySelector('input[name="' + prefix + '-INITIAL_FORMS"]');
    var tmpl         = document.getElementById(prefix + '-empty-form');

    var initialCount = parseInt((initialInput && initialInput.value) || '0', 10);

    // Remove any extra blank rows (indexes >= INITIAL_FORMS)
    var rows = Array.prototype.slice.call(rowsWrap.querySelectorAll('.fs-row'));
    rows.forEach(function(row){
      var pf  = row.getAttribute('data-prefix') || '';
      var idx = parseInt(pf.split('-').pop(), 10);
      if (!isNaN(idx) && idx >= initialCount && rowIsEmpty(row)) {
        var idInput = rowsWrap.querySelector('input[type="hidden"][name="'+ prefix + '-' + idx + '-id"]');
        if (idInput && idInput.parentNode) idInput.parentNode.removeChild(idInput);
        row.parentNode.removeChild(row);
      }
    });

    // Sync TOTAL_FORMS to the number of remaining rows
    var keptCount = rowsWrap.querySelectorAll('.fs-row').length;
    if (totalInput) totalInput.value = String(keptCount);

    // ADD ROW
    var addBtn = section.querySelector('.add-row');
    if (addBtn) {
      addBtn.addEventListener('click', function(){
        var total = parseInt(totalInput.value || '0', 10);
        var html = renumberForm(tmpl.innerHTML, prefix, total);
        var holder = document.createElement('div');
        holder.innerHTML = html;
        while (holder.firstChild) { rowsWrap.appendChild(holder.firstChild); }
        var newRow = rowsWrap.querySelector('.fs-row[data-prefix="' + prefix + '-' + total + '"]');
        totalInput.value = total + 1;
        updateCurrentToggles(newRow);
        try { if (window.flatpickr) { flatpickr(newRow.querySelectorAll('.js-date'), dateOpts); } } catch(e) {}
      });
    }

    updateCurrentToggles(rowsWrap);
  }

  // Global delete helper used by inline onclick on every Delete button.
  window.__formsetDelete = function(btn){
    var row = btn.closest('.fs-row');
    if (!row) return;
    var delInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (delInput) delInput.checked = true;
    row.style.display = 'none';
  };

  ['exp','edu','lnk'].forEach(setupSection);

  // Ensure Save always posts even if a browser would block submit
  var saveBtn = document.getElementById('save-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', function(){
      var form = document.getElementById('edit-form');
      if (form) form.submit();
    });
  }
})();
</script>


    </form>
  </div>
{% endblock %}
